# Destino SF - Production Deployment Implementation Plan

## üìä **Implementation Progress**

- ‚úÖ **Rate Limiting System** - COMPLETED (January 2025)
- ‚úÖ **Security Headers Configuration** - COMPLETED (January 2025)
- üîÑ **Webhook Signature Validation** - NEXT (Ready to start)
- ‚è≥ **Sentry Integration** - FUTURE
- ‚è≥ **Performance Monitoring** - FUTURE
- ‚è≥ **Database Connection Pooling** - FUTURE
- ‚è≥ **Health Check System** - FUTURE
- ‚è≥ **Caching Strategy** - FUTURE

**Current Status**: 2/8 critical tasks completed (25% complete)

## üî¥ Critical Security & Infrastructure Tasks

### ‚úÖ 1. Rate Limiting Implementation - COMPLETED

**Time: 6-8 hours | Priority: CRITICAL | Status: ‚úÖ DONE**

#### ‚úÖ Files Created:

```
‚úÖ src/lib/rate-limit.ts                    # Rate limiting service with token bucket algorithm
‚úÖ src/middleware/rate-limit.ts             # Rate limiting middleware functions
‚úÖ src/types/rate-limit.d.ts                # TypeScript types for rate limiting
‚úÖ src/app/api/test-rate-limit/route.ts     # Testing endpoint for rate limiting
```

#### ‚úÖ Files Modified:

```
‚úÖ src/middleware.ts                        # Integrated rate limiting before auth
‚úÖ src/app/api/webhooks/square/route.ts     # Added webhook rate limiting (100/min)
‚úÖ src/app/api/checkout/route.ts            # Added checkout rate limiting (10/min)
‚úÖ src/app/api/checkout/payment/route.ts    # Added payment rate limiting (5/min)
‚úÖ src/app/api/orders/[orderId]/retry-payment/route.ts # Added retry rate limiting (3/min)
‚úÖ package.json                             # Added @upstash/ratelimit @upstash/redis
‚úÖ src/env.ts                               # Added rate limiting environment variables
```

#### ‚úÖ Implementation Completed:

1. **‚úÖ Rate Limiter Service** (`src/lib/rate-limit.ts`)
   - ‚úÖ Token bucket algorithm using Upstash Redis
   - ‚úÖ Different limits for different endpoints
   - ‚úÖ IP-based and user-based limiting with graceful degradation

2. **‚úÖ Middleware Integration** (`src/middleware.ts`)
   - ‚úÖ Rate limit check before Supabase auth
   - ‚úÖ IP extraction from various headers (x-forwarded-for, cf-connecting-ip, etc.)
   - ‚úÖ Returns 429 Too Many Requests with proper headers

3. **‚úÖ Critical Endpoints Protected**
   - ‚úÖ `/api/webhooks/square/*` - 100 requests/minute
   - ‚úÖ `/api/checkout/*` - 10 requests/minute per IP
   - ‚úÖ `/api/checkout/payment/*` - 5 requests/minute per IP
   - ‚úÖ `/api/orders/*/retry-payment` - 3 requests/minute per user

#### ‚úÖ Testing Infrastructure:

- ‚úÖ Test endpoint: `/api/test-rate-limit`
- ‚úÖ Testing script: `scripts/test-rate-limiting.sh`
- ‚úÖ Documentation: `RATE_LIMITING_TEST_GUIDE.md`

---

### ‚úÖ 2. Security Headers Configuration - COMPLETED

**Time: 2-3 hours | Priority: CRITICAL | Status: ‚úÖ DONE**

#### ‚úÖ Files Created:

```
‚úÖ src/lib/security/csp-config.ts           # Centralized CSP configuration
‚úÖ src/app/api/security/headers-test/route.ts # Security headers validation endpoint
```

#### ‚úÖ Files Modified:

```
‚úÖ next.config.js                           # Comprehensive security headers configuration
‚úÖ src/middleware.ts                        # Enhanced security headers middleware
‚úÖ vercel.json                              # Vercel-specific security settings
```

#### ‚úÖ Implementation Completed:

1. **‚úÖ Security Headers in `next.config.js`**
   - ‚úÖ X-Frame-Options: DENY (prevent clickjacking)
   - ‚úÖ X-Content-Type-Options: nosniff (prevent MIME sniffing)
   - ‚úÖ X-XSS-Protection: 1; mode=block (legacy XSS protection)
   - ‚úÖ Referrer-Policy: strict-origin-when-cross-origin
   - ‚úÖ Permissions-Policy: camera=(), microphone=(), geolocation=(self)
   - ‚úÖ Content-Security-Policy: Comprehensive CSP with trusted domains
   - ‚úÖ Strict-Transport-Security: max-age=63072000; includeSubDomains; preload

2. **‚úÖ CSP Configuration**
   - ‚úÖ Allow Square SDK (js.squareup.com, web.squarecdn.com)
   - ‚úÖ Allow Google Maps & Fonts (maps.googleapis.com, fonts.googleapis.com)
   - ‚úÖ Allow Supabase (\*.supabase.co)
   - ‚úÖ Allow AWS S3 (\*.s3.amazonaws.com)
   - ‚úÖ Block dangerous inline scripts and external resources
   - ‚úÖ Environment-specific CSP (development vs production)

3. **‚úÖ Additional Security Features**
   - ‚úÖ X-Powered-By header removed (poweredByHeader: false)
   - ‚úÖ Server information hiding
   - ‚úÖ Request ID tracking for security monitoring
   - ‚úÖ Enhanced cache control for sensitive routes

#### ‚úÖ Testing Infrastructure:

- ‚úÖ Test endpoint: `/api/security/headers-test`
- ‚úÖ Testing script: `scripts/test-security-headers.sh`
- ‚úÖ Documentation: `docs/SECURITY_HEADERS_TEST_GUIDE.md`
- ‚úÖ Security summary: `docs/SECURITY_IMPLEMENTATION_SUMMARY.md`

---

### üîÑ 3. Webhook Signature Validation Enhancement - NEXT

**Time: 3-4 hours | Priority: CRITICAL | Status: üîÑ READY TO START**

#### Files to Modify:

```
src/app/api/webhooks/square/route.ts
src/lib/square/webhook-validator.ts (create)
src/lib/crypto-utils.ts (create)
```

#### Implementation:

1. **Create Webhook Validator**
   - Constant-time comparison
   - Replay attack prevention (timestamp validation)
   - Request body integrity check

2. **Add Request ID Tracking**
   - Store processed webhook IDs in Redis/DB
   - Prevent duplicate processing
   - Add TTL for cleanup

---

## üü† Monitoring & Error Handling

### 4. Sentry Integration

**Time: 3-4 hours | Priority: HIGH**

#### Files to Create:

```
sentry.client.config.ts
sentry.server.config.ts
sentry.edge.config.ts
src/lib/sentry.ts
```

#### Files to Modify:

```
src/lib/error-monitoring.ts
src/app/layout.tsx
src/app/error.tsx
src/app/global-error.tsx
next.config.js
```

#### Implementation:

1. **Initialize Sentry**

   ```typescript
   // sentry.client.config.ts
   // Configure DSN, environment, integrations
   // Set up performance monitoring
   // Configure user context
   ```

2. **Update Error Monitor** (`src/lib/error-monitoring.ts`)

   ```typescript
   // In logToExternalService method:
   // Sentry.captureException(error, {
   //   contexts: { custom: context },
   //   level: severity
   // });
   ```

3. **Add Error Boundaries**
   - Global error boundary
   - Route-specific error boundaries
   - Fallback UI components

---

### 5. Performance Monitoring

**Time: 4-5 hours | Priority: HIGH**

#### Files to Create:

```
src/lib/performance.ts
src/lib/metrics.ts
src/components/PerformanceObserver.tsx
```

#### Files to Modify:

```
src/app/layout.tsx
src/middleware.ts
next.config.js
```

#### Implementation:

1. **Web Vitals Tracking**
   - LCP, FID, CLS, TTFB
   - Custom metrics for checkout flow
   - API response time tracking

2. **Database Query Monitoring**
   ```typescript
   // Add to Prisma client configuration
   // Log slow queries
   // Track connection pool metrics
   ```

---

## üü° Infrastructure & Reliability

### 6. Database Connection Pooling

**Time: 2-3 hours | Priority: HIGH**

#### Files to Modify:

```
src/lib/db.ts
prisma/schema.prisma
.env.example
```

#### Implementation:

1. **Update Prisma Client** (`src/lib/db.ts`)

   ```typescript
   // Add connection pool configuration
   // Implement retry logic
   // Add connection timeout handling
   // Monitor pool statistics
   ```

2. **Add Connection String Parameters**
   ```
   DATABASE_URL="postgresql://...?connection_limit=10&pool_timeout=30"
   ```

---

### 7. Health Check System

**Time: 2-3 hours | Priority: HIGH**

#### Files to Create:

```
src/app/api/health/route.ts
src/app/api/health/detailed/route.ts
src/lib/health-checks.ts
```

#### Implementation:

1. **Basic Health Check** (`/api/health`)

   ```typescript
   // Return 200 OK for uptime monitoring
   // Include version info
   ```

2. **Detailed Health Check** (`/api/health/detailed`)
   ```typescript
   // Check database connectivity
   // Verify Square API access
   // Test Redis connection
   // Check email service
   // Verify file storage access
   ```

---

### 8. Caching Strategy

**Time: 4-5 hours | Priority: MEDIUM**

#### Files to Create:

```
src/lib/cache.ts
src/lib/cache-keys.ts
src/hooks/useCache.ts
```

#### Files to Modify:

```
src/app/api/products/route.ts
src/app/api/categories/route.ts
src/lib/square/catalog.ts
```

#### Implementation:

1. **Cache Service**
   - Redis/Upstash integration
   - TTL management
   - Cache invalidation strategy
   - Stale-while-revalidate

2. **Cache Key Patterns**
   ```typescript
   // products:${categoryId}:${page}
   // product:${productId}
   // user:${userId}:cart
   // square:catalog:${timestamp}
   ```

---

## üü¢ Testing & Documentation

### 9. Load Testing Suite

**Time: 4-5 hours | Priority: MEDIUM**

#### Files to Create:

```
tests/load/checkout-flow.js
tests/load/webhook-processing.js
tests/load/config.js
scripts/load-test.sh
```

#### Tools:

- K6 or Artillery for load testing
- Grafana for visualization

#### Test Scenarios:

1. **Checkout Flow**
   - 100 concurrent users
   - Complete purchase flow
   - Payment processing

2. **Webhook Processing**
   - 1000 webhooks/minute
   - Concurrent order updates
   - Error handling under load

---

### 10. API Documentation

**Time: 3-4 hours | Priority: MEDIUM**

#### Files to Create:

```
docs/api/openapi.yaml
src/lib/swagger.ts
src/app/api/docs/route.ts
```

#### Implementation:

1. **OpenAPI Specification**
   - Document all endpoints
   - Request/response schemas
   - Authentication requirements
   - Rate limits

2. **Swagger UI Integration**
   - Interactive documentation
   - Try-it-out functionality
   - Auto-generated from code

---

## üìã Environment Variables Checklist

### ‚úÖ Implemented for Production:

```env
# ‚úÖ Rate Limiting (IMPLEMENTED)
UPSTASH_REDIS_REST_URL=https://thorough-deer-37742.upstash.io
UPSTASH_REDIS_REST_TOKEN=AZNuAAIjcDFiYzk0OWU5OTRiZGI0ZjJjOGVkZGQ2YjMwYzFmY2NiZnAxMA
BYPASS_RATE_LIMIT=false  # Set to true only in development

# ‚úÖ Security Headers (IMPLEMENTED - No additional env vars needed)
```

### üîÑ Still Required for Production:

```env
# üîÑ Security (NEXT - Webhook validation)
NEXTAUTH_SECRET=
SQUARE_WEBHOOK_SECRET=

# üîÑ Monitoring (FUTURE)
SENTRY_DSN=
SENTRY_AUTH_TOKEN=
SENTRY_PROJECT=
SENTRY_ORG=

# üîÑ Performance (FUTURE)
CACHE_TTL_SECONDS=
CONNECTION_POOL_SIZE=
```

---

## üöÄ Deployment Checklist

### ‚úÖ Pre-deployment Completed:

- [x] **All TypeScript errors resolved** ‚úÖ
- [x] **Rate limiting environment variables configured** ‚úÖ
- [x] **Rate limiting tested** ‚úÖ (scripts/test-rate-limiting.sh)
- [x] **Security headers verified** ‚úÖ (scripts/test-security-headers.sh)

### üîÑ Pre-deployment Still Required:

- [ ] **Webhook signature validation tested** üîÑ (NEXT TASK)
- [ ] **Sentry error tracking confirmed** üîÑ (FUTURE)
- [ ] **Health checks passing** üîÑ (FUTURE)
- [ ] **Load tests completed** üîÑ (FUTURE)

### üîÑ Post-deployment Monitoring:

- [ ] **Monitor error rates** üîÑ (Ready - rate limiting in place)
- [ ] **Monitor rate limit hits** üîÑ (Ready - Redis monitoring available)
- [ ] **Review security headers** üîÑ (Ready - testing scripts available)
- [ ] **Check webhook processing** üîÑ (After webhook validation implementation)
- [ ] **Check performance metrics** üîÑ (FUTURE)
- [ ] **Verify email delivery** üîÑ (FUTURE)
- [ ] **Test checkout flow** üîÑ (FUTURE)

---

## üìä Monitoring Dashboard Setup

### Key Metrics to Track:

1. **Application Health**
   - Response times (p50, p95, p99)
   - Error rates by endpoint
   - Active users
   - Memory/CPU usage

2. **Business Metrics**
   - Orders per hour
   - Failed payments
   - Cart abandonment rate
   - Webhook processing time

3. **Infrastructure**
   - Database connection pool
   - Cache hit rates
   - Rate limit violations
   - External API latency
